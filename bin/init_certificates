#!/bin/sh

#	Generates a TLS certficate sign request (CSR)
#	and a key pair
BASEDIR=`pwd`
echo "*** Script to generate RSA key pair and certificate sign request (CSR) for a TLS certificate"
echo "*********************************************************************************************"

mkdir -p $BASEDIR/certs

if [ -z $1 ];then
	HOSTNAME=`hostname`
else
	HOSTNAME=$1
fi

which openssl >> /dev/null
if test $? != 0
then
	echo "??? No OpenSSL binary"
	exit
fi
export ALTNAME="DNS:${HOSTNAME},DNS:${HOSTNAME},URI:sip:${HOSTNAME}" 
export COMMONNAME=${HOSTNAME}
#	echo " ...will use ALTNAME  $ALTNAME "
KEYNAME=$BASEDIR/certs/$HOSTNAME.key
if ! test -f $KEYNAME
then
	openssl genrsa -out $KEYNAME 2048
else
	echo "*** Using existing TLS key. Remove $KEYNAME to generate a new one."
fi
DAYS=1200
echo "*** "
echo "*** Please give company name and server name (including domain name)"
echo "*** "
openssl req -new  -config $BASEDIR/etc/openssl.cnf -reqexts cj_req \
        -sha1 -key $KEYNAME \
        -out $BASEDIR/certs/${HOSTNAME}.csr -days ${DAYS} 

echo "=> Files in $BASEDIR/certs:"
echo "=> Key in $HOSTNAME.key"
echo "=> Certificate request in $HOSTNAME.csr"
cd $BASEDIR/certs
if ! test -f kamailio.key
then
ln -s ${HOSTNAME}.key kamailio.key
fi
echo "*** "
echo "*** The .csr file is the form you send to a certificate authority to sign."
echo "*** We recommend the www.cacert.org certificates for this service."
echo "*** "
echo "*** These are the files in $BASEDIR/cust/certs"
ls -l $BASEDIR/cust/certs/*
